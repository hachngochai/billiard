"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var i=0;i<e.length;i++){var s=e[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,s.key,s)}}function _createClass(t,e,i){return e&&_defineProperties(t.prototype,e),i&&_defineProperties(t,i),t}console.clear(),noise.seed(1e3*Math.random());var ASSET_PREFIX="https://s3-us-west-2.amazonaws.com/s.cdpn.io/111863/",PI=Math.PI,PI2=2*PI,Bodies=Matter.Bodies,Body=Matter.Body,Composite=Matter.Composite,Constraint=Matter.Constraint,Engine=Matter.Engine,Events=Matter.Events,Mouse=Matter.Mouse,MouseConstraint=Matter.MouseConstraint,Render=Matter.Render,Vector=Matter.Vector,World=Matter.World,COLORS={white:"white",red:"#F44336",black:"#212121",purple:"#9C27B0",blue:"#2196F3",green:"#8bc34a",yellow:"#FFC107",orange:"#FF9800",brown:"#795548",felt:"#757575",pocket:"#121212",frame:"#3E2723"},WIREFRAMES=!1,INCH=12,FOOT=12*INCH,BALL_DI=2.4375*INCH,BALL_RAD=BALL_DI/2,POCKET_DI=4.5*INCH,POCKET_RAD=POCKET_DI/2,WALL_DI=5*INCH,WALL_RAD=WALL_DI/2,TABLE_W=8*FOOT,TABLE_H=3.5*FOOT,RETURN_H=1.75*BALL_DI,VIEW_W=2*WALL_DI+TABLE_W,VIEW_H=2*WALL_DI+TABLE_H+RETURN_H,Ball=function(){function s(t){var e=t.number,i=t.cueball;_classCallCheck(this,s),this.cue=0===e,this.eight=8===e,this.stripes=8<e,this.solids=0<e&&e<8,this.number=e,this.diameter=BALL_DI,this.pocketed=!1,this.setInitialCoordinates(),this.setRender(),this.setColor(),this.cueball=i,this.build()}return _createClass(s,[{key:"setInitialCoordinates",value:function(){var t=s.positions[this.number].map(function(t){return rel(t)});this.x=t[0],this.y=t[1]}},{key:"setColor",value:function(){this.color=COLORS[["white","yellow","blue","red","purple","orange","green","brown","black","yellow","blue","red","purple","orange","green","brown"][this.number]]}},{key:"setRender",value:function(){this.render={fillStyle:"transparent",lineWidth:0}}},{key:"enable",value:function(){Body.setStatic(this.body,!1),this.pocketed=!1,this.body.isSensor=!1}},{key:"disable",value:function(){this.cue||Body.setStatic(this.body,!0),this.pocketed=!0,this.body.isSensor=!0}},{key:"rest",value:function(){this.setVelocity({x:0,y:0}),Body.setPosition(this.body,this.body.position),Body.update(this.body,0,0,0)}},{key:"reset",value:function(){this.enable(),this.setVelocity({x:0,y:0}),Body.setPosition(this.body,{x:this.x,y:this.y})}},{key:"pocket",value:function(t){var e=t.x,i=t.y;this.disable(),Body.setVelocity(this.body,{x:0,y:0}),Body.setAngle(this.body,0),Body.setPosition(this.body,{x:e,y:i}),Body.update(this.body,0,0,0)}},{key:"setVelocity",value:function(t){var e=t.x,i=t.y;Body.setVelocity(this.body,{x:e,y:i})}},{key:"build",value:function(){this.body=Bodies.circle(this.x,this.y,this.diameter/2,{render:this.render,label:"ball",restitution:.9,friction:.001,density:this.cue?21e-5:2e-4})}},{key:"fromCueball",get:function(){return{angle:Vector.angle(this.body.position,this.cueball.body.position)}}}],[{key:"positions",get:function(){var t=Math.PI/180*60,e=Math.sin(t),i=Math.cos(t),s=TABLE_W-TABLE_W/4,n=TABLE_H/2,o=[s,n],a=[s+e*BALL_DI,n-i*BALL_DI],r=[s+e*(2*BALL_DI),n-i*(2*BALL_DI)],l=[s+e*(3*BALL_DI),n-i*(3*BALL_DI)];return[[TABLE_W/4,TABLE_H/2],o,a,r,l,[o[0]+e*(4*BALL_DI),o[1]+i*(4*BALL_DI)],[l[0]+e*BALL_DI,l[1]+i*BALL_DI],[a[0]+e*BALL_DI*2,a[1]+i*BALL_DI*2],[a[0]+e*BALL_DI,a[1]+i*BALL_DI],[o[0]+e*BALL_DI,o[1]+i*BALL_DI],[o[0]+e*(2*BALL_DI),o[1]+i*(2*BALL_DI)],[o[0]+e*(3*BALL_DI),o[1]+i*(3*BALL_DI)],[s+e*(4*BALL_DI),n-i*(4*BALL_DI)],[a[0]+e*(3*BALL_DI),a[1]+i*(3*BALL_DI)],[r[0]+e*BALL_DI,r[1]+i*BALL_DI],[r[0]+e*(2*BALL_DI),r[1]+i*(2*BALL_DI)]]}}]),s}(),Table=function(){function L(){_classCallCheck(this,L),this.width=TABLE_W,this.height=TABLE_H,this.hypot=Math.hypot(TABLE_W,TABLE_H),this.build()}return _createClass(L,[{key:"build",value:function(){this.buildBounds(),this.buildWall(),this.buildPockets()}},{key:"buildBounds",value:function(){var t={isStatic:!0,render:{fillStyle:"red"},label:"bounds",friction:1,restitution:0,density:1},e=VIEW_W+2*VIEW_H,i=VIEW_H,s=VIEW_H;this.bounds=[Bodies.rectangle(.5*VIEW_W,-.5*s,e,s,t),Bodies.rectangle(.5*VIEW_W,VIEW_H+.5*s,e,s,t),Bodies.rectangle(-.5*i,.5*VIEW_H,i,s,t),Bodies.rectangle(VIEW_W+.5*i,.5*VIEW_H,i,s,t)]}},{key:"buildWall",value:function(){var t={isStatic:!0,render:{fillStyle:"transparent"},label:"wall",friction:.0025,restitution:.6,density:.125,slop:.5},e=L.wallVertices,i={width:1.5*WALL_DI,height:WALL_DI-POCKET_RAD},s={width:WALL_DI-POCKET_RAD,height:1.5*WALL_DI},n={width:WALL_DI-POCKET_RAD,height:WALL_DI-POCKET_RAD},o=i.height/2,a=rel(TABLE_H+WALL_DI-i.height/2),r=i.width/2,l=rel(TABLE_W+WALL_DI-i.width/2),h=s.height/2,c=rel(TABLE_H+WALL_DI-s.height/2),u=s.width/2,d=rel(TABLE_W+WALL_DI-s.width/2);this.walls=[Bodies.fromVertices(rel(TABLE_W/4),rel(TABLE_H+WALL_RAD),e.bottom,t),Bodies.fromVertices(rel(TABLE_W/4+TABLE_W/2),rel(TABLE_H+WALL_RAD),e.bottom,t),Bodies.fromVertices(rel(TABLE_W/4),rel(0-WALL_RAD),e.top,t),Bodies.fromVertices(rel(TABLE_W/4+TABLE_W/2),rel(0-WALL_RAD),e.top,t),Bodies.fromVertices(rel(0-WALL_RAD),rel(TABLE_H/2),e.left,t),Bodies.fromVertices(rel(TABLE_W+WALL_RAD),rel(TABLE_H/2),e.right,t),Bodies.rectangle(r,o,i.width,i.height,t),Bodies.rectangle(l,o,i.width,i.height,t),Bodies.rectangle(r,a,i.width,i.height,t),Bodies.rectangle(l,a,i.width,i.height,t),Bodies.rectangle(u,h,s.width,s.height,t),Bodies.rectangle(d,h,s.width,s.height,t),Bodies.rectangle(u,c,s.width,s.height,t),Bodies.rectangle(d,c,s.width,s.height,t),Bodies.rectangle(rel(TABLE_W/2),a,n.width,n.height,t),Bodies.rectangle(rel(TABLE_W/2),o,n.width,n.height,t)]}},{key:"buildPockets",value:function(){var t={render:{fillStyle:"transparent",lineWidth:0},label:"pocket",isSensor:!0},e=.75*WALL_DI,i=TABLE_H+1.25*WALL_DI,s=.75*WALL_DI,n=TABLE_W+1.25*WALL_DI;this.pockets=[Bodies.circle(s,e,POCKET_RAD,t),Bodies.circle(TABLE_W/2+WALL_DI,e,POCKET_RAD,t),Bodies.circle(n,e,POCKET_RAD,t),Bodies.circle(s,i,POCKET_RAD,t),Bodies.circle(TABLE_W/2+WALL_DI,i,POCKET_RAD,t),Bodies.circle(n,i,POCKET_RAD,t)]}}],[{key:"wallVertices",get:function(){var t={},e=(TABLE_W-2*POCKET_RAD)/4,i=(TABLE_H-POCKET_RAD)/2;return t.bottom=[{x:-e,y:WALL_DI},{x:e,y:WALL_DI},{x:e,y:POCKET_RAD},{x:e-POCKET_RAD,y:0},{x:-e+POCKET_RAD,y:0},{x:-e,y:POCKET_RAD}],t.top=[{x:-e,y:0},{x:e,y:0},{x:e,y:WALL_DI-POCKET_RAD},{x:e-POCKET_RAD,y:WALL_DI},{x:-e+POCKET_RAD,y:WALL_DI},{x:-e,y:WALL_DI-POCKET_RAD}],t.left=[{y:-i,x:0},{y:i,x:0},{y:i,x:WALL_DI-POCKET_RAD},{y:i-POCKET_RAD,x:WALL_DI},{y:-i+POCKET_RAD,x:WALL_DI},{y:-i,x:WALL_DI-POCKET_RAD}],t.right=[{y:-i,x:WALL_DI},{y:i,x:WALL_DI},{y:i,x:POCKET_RAD},{y:i-POCKET_RAD,x:0},{y:-i+POCKET_RAD,x:0},{y:-i,x:POCKET_RAD}],t}}]),L}(),Machine=function(){function t(){_classCallCheck(this,t),this.clock=0,this.fireCount=0,this.x=rel(.5*TABLE_W),this.y=rel(.5*TABLE_H)}return _createClass(t,[{key:"reset",value:function(t,e){var i=t.x,s=t.y;e?(this.x=rel(.5*TABLE_W),this.y=rel(.5*TABLE_H)):(this.x=i,this.y=s),this.power=0}},{key:"fire",value:function(){if(100<this.fireCount)return!(this.fireCount=0);var t=Math.random()<.0125;return t?this.fireCount=0:this.fireCount++,t}},{key:"tick",value:function(){var t=noise.perlin2(this.clock,this.clock),e=noise.perlin2(this.clock+100,this.clock+100),i=noise.perlin2(this.clock+1e3,this.clock+1e3);this.x=Math.max(Math.min(this.x+16*t,rel(TABLE_W)),rel(0)),this.y=Math.max(Math.min(this.y+16*e,rel(TABLE_H)),rel(0)),this.clock+=.02,this.power=.5*(i+1)*.8+.2}}]),t}(),Player=function(){function e(t){_classCallCheck(this,e),this.number=t,this.stripes=!1,this.solids=!1,this.points=0}return _createClass(e,[{key:"assign",value:function(t){t?this.stripes=!0:this.solids=!0}},{key:"score",value:function(t){this.points+=t}},{key:"onEight",get:function(){return 7===this.points}},{key:"winner",get:function(){return 8===this.points}},{key:"denomText",get:function(){return this.stripes?"Stripes":this.solids?"Solids":""}},{key:"invalidContactText",get:function(){return this.stripes?"".concat(this.nameText," did not hit a Stripe first."):this.solids?"".concat(this.nameText," did not hit a Solid first."):void 0}},{key:"nameText",get:function(){return 1===this.number?"<strong>You</strong>":"<strong>AI</strong>"}},{key:"eightText",get:function(){return"".concat(this.nameText," Pocketed the Eight.")}},{key:"scratchText",get:function(){return"".concat(this.nameText," Scratched!")}},{key:"turnText",get:function(){var t=1===this.number?"Your":"AI's";return t="<strong>".concat(t,"</strong>"),t+=" Turn ",(this.stripes||this.solids)&&(t+="(".concat(this.denomText,")")),t}},{key:"winText",get:function(){return 1===this.number?"<strong>You</strong> Win!":"<strong>AI</strong> Wins!"}},{key:"teamText",get:function(){return"".concat(this.nameText," is ").concat(this.denomText)}}]),e}(),Canvas=function(){function i(t){var e=t.context;_classCallCheck(this,i),this.context=e}return _createClass(i,[{key:"drawCrosshair",value:function(t){var e=t.x,i=t.y;this.context.fillStyle="rgba(255, 255, 255, 0.25)",this.context.beginPath(),this.context.arc(e,i,BALL_RAD,0,PI2,!1),this.context.fill()}},{key:"drawMovingCrosshair",value:function(t){var e=t.x,i=t.y,s=BALL_RAD-2;this.context.strokeStyle=COLORS.red,this.context.lineWidth=4,this.context.translate(e,i),this.context.rotate(.25*-PI),this.context.beginPath(),this.context.arc(0,0,s,0,PI2,!1),this.context.stroke(),this.context.beginPath(),this.context.moveTo(0,-.5*(BALL_RAD+2)),this.context.lineTo(0,.5*(BALL_RAD+2)),this.context.stroke(),this.context.rotate(.25*PI),this.context.translate(-e,-i)}},{key:"drawTable",value:function(t){var e=t.wallBodies,i=t.pocketBodies;this.drawSlate(),this.drawWall(e),this.drawReturn(),this.drawPockets(i),this.drawPoints()}},{key:"drawSlate",value:function(){var t=this.context.createRadialGradient(.5*VIEW_W,.5*(VIEW_H-RETURN_H),.75*TABLE_H*.125,.5*VIEW_W,.5*(VIEW_H-RETURN_H),.75*TABLE_H*1.5);t.addColorStop(0,"rgba(255,255,255,0.05)"),t.addColorStop(.25,"rgba(255,255,255,0.05)"),t.addColorStop(1,"rgba(255,255,255,0.15)"),this.context.fillStyle=COLORS.felt,this.context.fillRect(WALL_RAD,WALL_RAD,TABLE_W+WALL_DI,TABLE_H+WALL_DI),this.context.fillStyle=t,this.context.fillRect(WALL_RAD,WALL_RAD,TABLE_W+WALL_DI,TABLE_H+WALL_DI)}},{key:"drawReturn",value:function(){var t=.5*(RETURN_H-1.2*BALL_DI);this.context.fillStyle=COLORS.pocket,this.context.fillRect(t,VIEW_H-RETURN_H+t,VIEW_W-2*t,RETURN_H-2*t)}},{key:"drawWall",value:function(t){var n=this;this.context.fillStyle=COLORS.frame,t.forEach(function(t,e){n.context.beginPath(),t.vertices.forEach(function(t,e){var i=t.x,s=t.y;0===e?n.context.moveTo(i,s):n.context.lineTo(i,s)}),n.context.fill(),n.context.save(),n.context.beginPath(),t.vertices.forEach(function(t,e){var i=t.x,s=t.y;0===e?n.context.moveTo(i,s):n.context.lineTo(i,s)}),n.context.clip(),n.context.fillStyle="#787878";var i=.75*WALL_DI,s=WALL_DI-i;n.context.fillRect(i,i,TABLE_W+2*s,TABLE_H+2*s),n.context.restore()})}},{key:"drawPockets",value:function(t){var s=this;this.context.fillStyle=COLORS.pocket,t.forEach(function(t){var e=t.position,i=t.circleRadius;s.context.beginPath(),s.context.arc(e.x,e.y,i,0,PI2,!1),s.context.fill()})}},{key:"drawPoints",value:function(){var s=this,t=TABLE_W/7,e=rel(.25*TABLE_W),i=e-t,n=e+t,o=e+.5*TABLE_W,a=o-t,r=o+t,l=.75*WALL_RAD,h=rel(TABLE_W+1.25*WALL_RAD),c=.75*WALL_RAD,u=rel(TABLE_H+1.25*WALL_RAD),d=rel(.5*TABLE_H),L=d-t,y=d+t,_=[[i,c],[e,c],[n,c],[i,u],[e,u],[n,u],[a,c],[o,c],[r,c],[a,u],[o,u],[r,u],[l,L],[l,d],[l,y],[h,L],[h,d],[h,y]];this.context.fillStyle=COLORS.brown,_.forEach(function(t){var e=t[0],i=t[1];s.context.beginPath(),s.context.moveTo(e,i-5),s.context.lineTo(e+5,i),s.context.lineTo(e,i+5),s.context.lineTo(e-5,i),s.context.fill()})}},{key:"drawIndicator",value:function(t){var e=t.x,i=t.y,s=t.cueball,n=t.power,o=t.maxDistance;this.cueX=s.position.x,this.cueY=s.position.y,this.angle=Math.atan2(i-this.cueY,e-this.cueX),this.angleCos=Math.cos(this.angle),this.angleSin=Math.sin(this.angle);var a=this.cueX+1.2*BALL_DI*this.angleCos,r=this.cueY+1.2*BALL_DI*this.angleSin,l=a+o*this.angleCos,h=r+o*this.angleSin,c=a+n*o*this.angleCos,u=r+n*o*this.angleSin;this.forceX=(c-a)/o*.02,this.forceY=(u-r)/o*.02,this.context.lineCap="round",this.context.strokeStyle="rgba(255, 255, 255, 0.1)",this.context.lineWidth=4,this.context.beginPath(),this.context.moveTo(a,r),this.context.lineTo(l,h),this.context.stroke(),this.context.closePath(),this.context.strokeStyle="rgba(255, 255, 255, 0.9)",this.context.lineWidth=4,this.context.beginPath(),this.context.moveTo(a,r),this.context.lineTo(c,u),this.context.stroke(),this.context.closePath()}},{key:"drawBalls",value:function(t){for(var e=t.balls,i=t.ballIds,s=0,n=i.length;s<n;s++){var o=e[i[s]];this.drawBall(o)}}},{key:"drawBall",value:function(t){var e=t.body.position.x,i=t.body.position.y,s=t.body.circleRadius,n=t.body.angle;this.context.translate(e,i),this.context.rotate(n);var o=(e-WALL_DI)/TABLE_W*2-1,a=(i-WALL_DI)/TABLE_H*2-1,r=this.context.createRadialGradient(s*o,s*a,.125*s,s*o,s*a,1.5*s);if(t.eight?(r.addColorStop(0,"rgba(255,255,255,0.15)"),r.addColorStop(1,"rgba(255,255,255,0.05)")):(r.addColorStop(0,"rgba(0,0,0,0.05)"),r.addColorStop(1,"rgba(0,0,0,0.3)")),this.context.shadowColor="rgba(0,0,0,0.05)",this.context.shadowBlur=2,this.context.shadowOffsetX=-o*BALL_RAD*.5,this.context.shadowOffsetY=-a*BALL_RAD*.5,this.context.fillStyle=t.color,this.context.beginPath(),this.context.arc(0,0,s,0,PI2,!1),this.context.fill(),this.context.shadowColor="transparent",t.stripes){var l=.15*PI,h=PI-l,c=-.15*PI,u=PI-c;this.context.fillStyle="white",this.context.beginPath(),this.context.arc(0,0,s,l,h,!1),this.context.fill(),this.context.beginPath(),this.context.arc(0,0,s,c,u,!0),this.context.fill()}this.context.rotate(-n),this.context.beginPath(),this.context.arc(0,0,s,0,PI2,!1),this.context.fillStyle=r,this.context.fill(),this.context.translate(-e,-i)}}]),i}(),Game=function(){function o(t){var i=this,e=t.world,s=t.canvas,n=t.sounds;_classCallCheck(this,o),this.machine=new Machine,this.sounds=n,this.world=e,this.canvas=s,this.$score=document.querySelector("div.score"),this.$message=document.querySelector("div.message"),this.table=new Table,this.balls={},this.ballIds=[],this.ballNumbers.forEach(function(t){var e=new Ball({number:t,cueball:i.cueball});e.cue&&(i.cueId=e.body.id),e.eight&&(i.eightId=e.body.id),i.balls[e.body.id]=e,i.ballIds.push(e.body.id)}),this.addBodiesToWorld(),initEscapedBodiesRetrieval(this.ballIds.map(function(t){return i.balls[t].body})),this.reset()}return _createClass(o,[{key:"handleEscapedBall",value:function(t){console.log("ESCAPED",this.balls[t]),this.balls[t].reset()}},{key:"reset",value:function(){var e=this;this.gameOver=!1,this.break=!0,this.mousedown=!1,this.power=0,this.powerStep=.015,this.powerDirection=1,this.players=[new Player(1),new Player(2)],this.playersAssigned=!1,this.currentPlayerIdx=0,this.messages=[this.currentPlayer.turnText],this.pocketedThisTurn=[],this.pocketedStripes=0,this.pocketedSolids=0,this.placingCueball=!0,this.ballIds.forEach(function(t){return e.balls[t].reset()}),this.updateDOM()}},{key:"addBodiesToWorld",value:function(){var e=this;World.add(this.world,this.table.bounds),World.add(this.world,this.table.walls),World.add(this.world,this.table.pockets),World.add(this.world,this.ballIds.map(function(t){return e.balls[t].body}))}},{key:"handleMousedown",value:function(){this.gameOver||this.moving||this.placingCueball||(this.mousedown=!0)}},{key:"handleMouseup",value:function(){this.gameOver||(this.mousedown=!1,this.moving||(this.placingCueball?this.placeCueball():this.strikeCueball()))}},{key:"handlePocketed",value:function(t){var e=this.balls[t];e.cue&&this.setupCueball(),this.handlePocketedBall(e)}},{key:"handlePocketedBall",value:function(t){this.pocketedThisTurn.push(t);var e,i=VIEW_H-RETURN_H/2;t.stripes?(e=VIEW_W-this.pocketedStripes*(1.2*BALL_DI)-.5*RETURN_H,this.pocketedStripes++):t.solids?(e=this.pocketedSolids*(1.2*BALL_DI)+.5*RETURN_H,this.pocketedSolids++):e=t.cue?.5*VIEW_W+1.1*BALL_RAD:.5*VIEW_W-1.1*BALL_RAD,t.pocket({x:e,y:i})}},{key:"handleTickAfter",value:function(t){var e=t.x,i=t.y;this.tickPower();var s=this.power,n=this.moving;this.checkMovement();var o=this.moving;n&&!o&&this.handleTurnEnd();var a={x:e,y:i};this.canvas.drawTable({wallBodies:this.table.walls,pocketBodies:this.table.pockets}),this.canvas.drawBalls({balls:this.balls,ballIds:this.ballIds});var r=this.isMachine&&this.machine.fire();this.isMachine&&(this.machine.tick(),e=this.machine.x,i=this.machine.y,s=this.machine.power),r&&this.handleMousedown(),this.placingCueball?this.moveCueball(e,i):this.moving||this.gameOver||this.canvas.drawIndicator({x:e,y:i,power:s,cueball:this.cueball.body,maxDistance:.5*this.table.height}),r&&this.handleMouseup(),(o||this.isMachine)&&this.canvas.drawMovingCrosshair(a),o||this.canvas.drawCrosshair({x:e,y:i})}},{key:"handleCollisionActive",value:function(t){var a=this;t.pairs.forEach(function(t,e){var i=t.bodyA,s=t.bodyB,n=i.label+s.label;if("ballpocket"===n||"pocketball"==n){var o="ball"===i.label?i:s;Math.hypot(i.position.y-s.position.y,i.position.x-s.position.x)/BALL_DI<=1&&a.handlePocketed(o.id)}})}},{key:"handleCollisionStart",value:function(t){var c=this,e=t.pairs;this.placingCueball||e.forEach(function(t,e){var i=t.bodyA,s=t.bodyB,n=t.collision.axisBody.speed,o=i.label+s.label;if(c.firstContact||"ballball"!==o||(c.firstContact=[i,s]),"ballball"===o){var a=Math.min(.5,n)+.05,r=Math.random()-.5+1;c.sounds.ball.rate(r),c.sounds.ball.volume(a),c.sounds.ball.play()}else if("ballwall"===o||"wallball"===o){var l=.8*Math.min(1,n)+.2,h=Math.random()-.5+.75;c.sounds.rail.rate(h),c.sounds.rail.volume(l),c.sounds.rail.play()}})}},{key:"handleTurnEnd",value:function(){var e=this;this.restBalls(),this.messages=[],this.power=0;var t=this.pocketedThisTurn,i=null,s=0<t.filter(function(t){return t.cue}).length,n=0<t.filter(function(t){return t.eight}).length,o=!0;if(this.firstContact){var a=this.firstContact.map(function(t){return e.balls[t.id]}).filter(function(t){return!t.cue})[0];!this.playersAssigned||s||n||(this.currentPlayer.stripes&&!a.stripes||this.currentPlayer.solids&&!a.solids)&&(o=!1),this.firstContact=null}if(0<t.length){var r=t.filter(function(t){return t.stripes}),l=t.filter(function(t){return t.solids}),h=0<r.length,c=0<l.length;this.playersAssigned||h&&c||s||n||(this.currentPlayer.assign(h),this.otherPlayer.assign(!h),this.playersAssigned=!0),this.currentPlayer.stripes?(this.currentPlayer.score(r.length),this.otherPlayer.score(l.length)):this.currentPlayer.solids&&(this.currentPlayer.score(l.length),this.otherPlayer.score(r.length)),n?(this.messageEight(),i=this.currentPlayer.onEight?this.currentPlayer:this.otherPlayer):s?(this.messageScratch(),this.switchTurns()):o?(!h&&this.currentPlayer.stripes||!c&&this.currentPlayer.solids)&&this.switchTurns():(this.messageInvalidContact(),this.switchTurns())}else s&&this.messageScratch(),this.switchTurns();if(this.pocketedThisTurn=[],i?(this.messageWin(i),this.handleGameOver()):this.messageTurn(),this.isMachine){var u=this.aMachineBall;this.machine.reset(u.body.position,this.placingCueball)}this.updateDOM()}},{key:"handleGameOver",value:function(){var t=this;this.gameOver=!0;var e=document.createElement("button");e.innerHTML="New Game",e.addEventListener("click",function(){e.remove(),t.reset()}),document.body.appendChild(e)}},{key:"messageTurn",value:function(){this.messages.push(this.currentPlayer.turnText)}},{key:"messageScratch",value:function(){this.messages.push(this.currentPlayer.scratchText)}},{key:"messageInvalidContact",value:function(){this.messages.push(this.currentPlayer.invalidContactText)}},{key:"messageEight",value:function(){this.messages.push(this.currentPlayer.eightText)}},{key:"messageWin",value:function(t){this.messages.push(t.winText)}},{key:"restBalls",value:function(){var e=this;this.ballIds.forEach(function(t){return e.balls[t].rest()})}},{key:"strikeCueball",value:function(){this.break=!1,this.moving=!0;var t=this.isMachine?this.machine.power:this.power,e=.9*Math.min(1,t)+.1;this.sounds.cue.volume(e),this.sounds.cue.play(),Body.applyForce(this.cueball.body,this.cueball.body.position,{x:this.canvas.forceX,y:this.canvas.forceY})}},{key:"setupCueball",value:function(){this.cueball.disable(),this.placingCueball=!0}},{key:"placeCueball",value:function(){this.cueball.enable(),this.cueball.pocketed=!1,this.placingCueball=!1}},{key:"moveCueball",value:function(t,e){if(this.moving)t=rel(TABLE_W/2),e=rel(TABLE_H+WALL_DI+.5*RETURN_H);else{var i=this.break?rel(TABLE_W/4-BALL_RAD):rel(TABLE_W-BALL_RAD),s=rel(0+BALL_RAD),n=rel(TABLE_H-BALL_RAD),o=rel(0+BALL_RAD);t=Math.min(i,Math.max(s,t)),e=Math.min(n,Math.max(o,e))}this.cueball.setVelocity({x:0,y:0}),Body.setPosition(this.cueball.body,{x:t,y:e})}},{key:"tickPower",value:function(){this.mousedown&&(this.power+=this.powerStep*this.powerDirection,this.power<0?(this.powerDirection=1,this.power=0):1<this.power&&(this.powerDirection=-1,this.power=1))}},{key:"updateDOM",value:function(){var t=this.currentPlayerIdx%2;this.$score.innerHTML=this.updatePlayerDOM(this.players[0],0==t)+this.updatePlayerDOM(this.players[1],1==t),this.$message.innerHTML="<p>"+this.messages.map(function(t){return t}).join(" ")+"</p>"}},{key:"updatePlayerDOM",value:function(t){return"<span>\n  <span>".concat(t.nameText,"</span>\n  <span>").concat(t.points,"</span>\n</span>")}},{key:"switchTurns",value:function(){this.currentPlayerIdx++}},{key:"checkMovement",value:function(){if(this.moving){for(var t=!1,e=0,i=this.ballIds.length;e<i&&!t;e++){var s=this.ballIds[e],n=this.balls[s];n.body&&.125<n.body.speed&&(t=!0)}this.moving=t}}},{key:"currentPlayer",get:function(){return this.players[this.currentPlayerIdx%2]}},{key:"otherPlayer",get:function(){return this.players[(this.currentPlayerIdx+1)%2]}},{key:"isMachine",get:function(){return this.currentPlayerIdx%2!=0}},{key:"aMachineBall",get:function(){var e=this,t=this.ballIds.map(function(t){return e.balls[t]}).filter(function(t){return!t.pocketed});return(t=this.players[1].onEight?[this.eightball]:this.players[1].stripes?t.filter(function(t){return t.stripes}):this.players[1].solids?t.filter(function(t){return t.solids}):t.filter(function(t){return!t.cue&&!t.eight}))[Math.floor(Math.random()*t.length)]}},{key:"cueball",get:function(){return this.balls[this.cueId]}},{key:"eightball",get:function(){return this.balls[this.eightId]}},{key:"ballNumbers",get:function(){return[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15]}}]),o}(),world=World.create({gravity:{x:0,y:0}}),engine=Engine.create({world:world,timing:{timeScale:1}}),element=document.querySelector("div.canvas"),render=Render.create({element:element,engine:engine,options:{width:VIEW_W,height:VIEW_H,wireframes:WIREFRAMES,background:COLORS.frame}});if(window.location.href.match(/cpgrid/)){document.body.classList.add("screenshot");var src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/111863/billiards.png",img=new Image;img.src=src,document.body.appendChild(img)}else{var canvas=new Canvas(render),mouse=Mouse.create(render.canvas),sounds={cue:new Howl({src:[ASSET_PREFIX+"billiards-cue.mp3",ASSET_PREFIX+"billiards-cue.ogg"]}),ball:new Howl({src:[ASSET_PREFIX+"billiards-ball.mp3",ASSET_PREFIX+"billiards-ball.ogg"]}),rail:new Howl({src:[ASSET_PREFIX+"billiards-rail.mp3",ASSET_PREFIX+"billiards-rail.ogg"]})},_game=new Game({world:world,canvas:canvas,sounds:sounds});Events.on(render,"afterRender",function(){_game.handleTickAfter({x:mouse.position.x,y:mouse.position.y})});var constraint=MouseConstraint.create(engine,{mouse:mouse});Events.on(constraint,"mousedown",function(t){t.mouse;_game.handleMousedown()}),Events.on(constraint,"mouseup",function(t){t.mouse;_game.handleMouseup()}),Events.on(engine,"collisionActive",function(t){_game.handleCollisionActive({pairs:t.pairs})}),Events.on(engine,"collisionStart",function(t){_game.handleCollisionStart({pairs:t.pairs})}),Engine.run(engine),Render.run(render)}function rel(t){return t+WALL_DI}function initEscapedBodiesRetrieval(o){setInterval(function(){var t,e,i,s,n;for(t=0;t<o.length;t++)e=o[t],void 0,i=e.position,s=i.x,n=i.y,(s<0||VIEW_W<s||n<0||VIEW_H<n)&&game.handleEscapedBall(e.id)},300)}
//# sourceMappingURL=main.min.js.map
